<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="apple-touch-icon" sizes="76x76" href="./assets/img/apple-icon.png">
    <link rel="icon" type="image/png" href="./assets/img/favicon.png">
    <link rel="stylesheet" href="assets/css/style.css">

    <title>
        Split It - Divide tus gastos
    </title>

    <link rel="stylesheet" type="text/css"
        href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,900" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="index-page bg-light">

    <!-- Header -->
    <header class="header py-5 text-center text-white">
        <div class="container banner">
            <h1 class="font-weight-bolder">Split It</h1>
            <p class="text-white-50 mt-3">Divide tus gastos de manera sencilla y precisa con amigos y familiares.</p>
            <a href="#crear-grupo" class="btn btn-primary mt-4" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">Empieza a crear</a>
        </div>
    </header>

    <!-- Contenido principal -->
    <main class="container mt-5">
        <!-- Crear un grupo -->
        <div class="accordion accordion-flush" id="accordionFlushExample">
            <div class="accordion-item bg-transparent border-0">
              <div id="flush-collapseOne" class="accordion-collapse collapse show" aria-labelledby="flush-headingOne" data-bs-parent="#accordionFlushExample">
                <div class="accordion-body p-0">
                    <section id="crear-grupo" class="mb-5">
                        <div class="card custom-card">
                            <div class="card-header card-header-custom">
                                <h5 class="card-title mb-0">Nuevo grupo</h5>
                            </div>
                            <div class="card-body bg-transparent">
                                <form id="grupoForm">
                                    <div class="mb-3">
                                        <label for="nombreGrupo" class="form-label fw-bolder">Nombre del grupo</label>
                                        <input type="text" id="nombreGrupo" class="form-control border p-2"
                                            placeholder="Ejemplo: Viaje a la playa" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="participantes" class="form-label fw-bolder d-block m-0">Participantes</label>
                                        <small class="text-danger fw-bolder">(Separados por comas: Ej Juan, Maria, Pedro)</small>
                                        <input type="text" id="participantes" class="form-control border p-2"
                                            placeholder="Ejemplo: Juan, María, Pedro" required>
                                    </div>
                                    <div class="text-end">
                                        <button type="submit" class="btn btn-primary">Guardar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <!-- Listado de grupos -->
        <section id="grupos-creados">
            <h5 class="mb-4 text-primary text-capitalize">Grupos creados</h5>
            <div id="listaGrupos" class="row gy-3">
                <p class="text-muted">No tienes grupos creados todavía.</p>
            </div>
        </section>

        <!-- Dividir gastos -->
        <section id="dividir-gastos" class="mt-5">
            <div class="card custom-card">
                <div class="card-header card-header-custom">
                    <h5 class="card-title mb-0">Dividir gastos</h5>
                </div>
                <div class="card-body">
                    <form id="gastoForm">
                        <div class="mb-3">
                            <label for="grupoSeleccionado" class="form-label">Selecciona un grupo</label>
                            <select id="grupoSeleccionado" class="form-select" required>
                                <option value="">Selecciona un grupo</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="montoTotal" class="form-label">Monto total</label>
                            <input type="number" id="montoTotal" class="form-control border p-2" placeholder="Ejemplo: 1000"
                                required>
                        </div>
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary">Calcular</button>
                        </div>
                    </form>
                    <div id="resultadoGasto" class="" style="display: none;">
                        <h6 class="text-success">Resultado</h6>
                        <p>Cada persona debe pagar: <span class="fw-bolder text-success" id="resultadoMonto"></span></p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Botón de Logout -->
    <button onclick="logout()" class="btn btn-danger position-fixed top-0 end-0 m-3">
        <i data-feather="log-out"></i>
    </button>

    <!-- Footer -->
    <footer class="footer mt-5 py-3 bg-dark">
        <div class="container text-center">
            <p class="text-white mb-0">&copy;
                <script>document.write(new Date().getFullYear())</script> Split It. Todos los derechos reservados.
            </p>
        </div>
    </footer>

    <script src="./assets/js/core/popper.min.js" type="text/javascript"></script>
    <script src="./assets/js/core/bootstrap.min.js" type="text/javascript"></script>
    <script src="./assets/js/plugins/perfect-scrollbar.min.js"></script>
    <script src="./assets/js/material-kit.min.js?v=3.1.0" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function showToast(icon, title) {
            Swal.fire({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true,
                icon: icon,
                title: title
            });
        }
    
        function logout() {
            localStorage.removeItem('loggedInUser');
            showToast('info', 'Cerrando sesión...');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
        }
    
        const loggedInUser = localStorage.getItem('loggedInUser');
        if (!loggedInUser) {
            window.location.href = 'index.html';
        }
    
        const users = JSON.parse(localStorage.getItem('users')) || [];
        const user = users.find(u => u.email === loggedInUser);
    
        if (!user) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se encontró el usuario. Inicia sesión nuevamente.',
            }).then(() => {
                localStorage.removeItem('loggedInUser');
                window.location.href = 'index.html';
            });
        }
    
        function saveUserData() {
            const updatedUsers = users.map(u => (u.email === user.email ? user : u));
            localStorage.setItem('users', JSON.stringify(updatedUsers));
        }
    
        // Crear grupos
        document.getElementById('grupoForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const nombreGrupo = document.getElementById('nombreGrupo').value;
            const participantes = document.getElementById('participantes').value.split(',').map(p => p.trim());
    
            const nuevoGrupo = { nombre: nombreGrupo, participantes };
            user.grupos = user.grupos || [];
            user.grupos.push(nuevoGrupo);
            saveUserData();
    
            renderGroups();
            document.getElementById('grupoForm').reset();
            showToast('success', 'Grupo creado exitosamente');
        });
    
        // Eliminar grupos
        function deleteGroup(index) {
            user.grupos.splice(index, 1);
            saveUserData();
            renderGroups();
            showToast('info', 'Grupo eliminado');
        }
    
        // Renderizar grupos
        function renderGroups() {
            const listaGrupos = document.getElementById('listaGrupos');
            const grupoSeleccionado = document.getElementById('grupoSeleccionado');
    
            listaGrupos.innerHTML = '';
            grupoSeleccionado.innerHTML = '<option value="">Selecciona un grupo</option>';
    
            if (user.grupos && user.grupos.length > 0) {
                user.grupos.forEach((g, index) => {
                    const grupoHTML = `
                        <div class="col-md-6">
                            <div class="card custom-card">
                                <div class="card-body">
                                    <h6>${g.nombre}</h6>
                                    <p class="text-muted">Participantes: ${g.participantes.join(', ')}</p>
                                    <button onclick="deleteGroup(${index})" class="btn btn-danger btn-sm btn-icon">
                                        <i data-feather="trash" class="h2 m-0"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    listaGrupos.innerHTML += grupoHTML;
    
                    grupoSeleccionado.innerHTML += `<option value="${index}">${g.nombre}</option>`;
                });
            } else {
                listaGrupos.innerHTML = `<p class="text-muted">No tienes grupos creados todavía.</p>`;
            }
    
            feather.replace();
        }
    
        // Calcular gastos
        document.getElementById('gastoForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const grupoSeleccionado = document.getElementById('grupoSeleccionado').value;
            const montoTotal = parseFloat(document.getElementById('montoTotal').value);
    
            if (grupoSeleccionado === '') {
                Swal.fire({
                    icon: 'warning',
                    title: 'Atención',
                    text: 'Debes seleccionar un grupo.',
                });
                return;
            }
    
            const grupo = user.grupos[grupoSeleccionado];
            const numeroPersonas = grupo.participantes.length;
    
            if (numeroPersonas > 0) {
                const montoPorPersona = (montoTotal / numeroPersonas).toFixed(2);
                document.getElementById('resultadoMonto').textContent = `$${montoPorPersona}`;
                document.getElementById('resultadoGasto').style.display = 'block';
                showToast('success', 'Cálculo realizado con éxito');
            }
        });
    
        // Cargar datos iniciales
        renderGroups();
    </script>
    
</body>

</html>
